<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ SPM SC è¶…å¼ºè®­ç»ƒå™¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:700px; margin:auto; text-align:center; }
    #welcome,#menu,#quiz,#finish { margin:20px; }
    #menu,#quiz,#finish { display:none; }
    #topbar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin:12px 0; }
    #menu button,#controls button { margin:5px; padding:8px 12px; }
    .question { text-align:left; margin:15px 0; padding:16px 20px; border:2px solid #ddd; border-radius:14px; transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease; }
    .option-label { display:block; margin:6px 0; cursor:pointer; }
    .feedback { font-weight:bold; margin:10px 0; min-height:1.2em; }
    input[type="text"], input[type="password"] { width:100%; padding:10px; margin:6px 0; border-radius:10px; border:1px solid #ccc; }
    input[type="radio"],input[type="checkbox"] { transform:scale(1.2); margin-right:8px; }
    img { max-width:100%; margin:10px 0; border:2px solid #ccc; border-radius:10px; }
    .help { font-size: 0.95em; color:#444; margin-top:8px; }

    /* é¡¶éƒ¨æ§ä»¶ */
    #session-timer {
      background: #111; color:#fff; padding:8px 12px; border-radius:999px;
      font-size: 12px; letter-spacing:.5px; opacity:.9; display:none; z-index: 9999;
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
    }
    #sound-toggle { border:0; background:#111; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    #sound-toggle.muted { background:#555; }

    /* è¿›åº¦æ¡å®¹å™¨ + åŠ¨æ€é«˜äº® */
    .progress-wrap { width:100%; margin-top:6px; border-radius:12px; padding:6px; transition: box-shadow .25s ease; }
    .progress-wrap.flash-green { box-shadow: 0 0 0 4px rgba(34,197,94,.25); }
    .progress-wrap.flash-red   { box-shadow: 0 0 0 4px rgba(239,68,68,.25); }
    progress { width:100%; height:20px; }
    progress::-webkit-progress-bar { background-color:#eee; border-radius:10px; }
    progress::-webkit-progress-value { background-color:#111; border-radius:10px; }
    progress::-moz-progress-bar { background:#111; border-radius:10px; }

    /* streak å¾½ç«  */
    #streak { margin-top:6px; font-size:13px; color:#555; min-height:1.2em; }
    .streak-good { color:#16a34a; }
    .streak-bad  { color:#dc2626; }

    /* äº¤äº’åŠ¨ç”» */
    .correct-glow { border-color:#23c55e !important; box-shadow: 0 0 0 4px rgba(34,197,94,.15); transform: scale(1.01); }
    .wrong-shake { border-color:#ef4444 !important; animation: shake .28s ease-in-out 0s 1, flashRed .9s ease 0s 1; }
    @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-3px);} 40%,60% { transform: translateX(3px);} }
    @keyframes flashRed { 0% { box-shadow:0 0 0 0 rgba(239,68,68,.35);} 100% { box-shadow:0 0 0 10px rgba(239,68,68,0);} }
    .score-bubble {
      position:absolute; right:10px; top:-6px; font-weight:700;
      padding:2px 8px; border-radius:999px; font-size:12px;
      animation: popUp 900ms ease forwards; pointer-events:none;
    }
    .score-bubble.plus { background: rgba(34,197,94,.15); color:#16a34a; }
    .score-bubble.minus { background: rgba(239,68,68,.15); color:#dc2626; }
    @keyframes popUp { 0%{ transform: translateY(0); opacity:0; } 15%{ opacity:1; } 100%{ transform: translateY(-24px); opacity:0; } }

    /* é€šç”¨æŒ‰é’® */
    button { border:0; background:#111; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    /* å½©å¸¦å®¹å™¨ */
    #confetti { position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:9998; }
    .confetti-piece {
      position:absolute; width:10px; height:16px; opacity:0.9; border-radius:3px;
      animation: fall linear forwards;
    }
    @keyframes fall {
      0% { transform: translateY(-120%) rotate(0deg); }
      100% { transform: translateY(120vh) rotate(720deg); }
    }
  </style>
</head>
<body>

  <!-- é¡¶éƒ¨æ¡ï¼šä¼šè¯å€’è®¡æ—¶ + é™éŸ³å¼€å…³ -->
  <div id="topbar">
    <div id="session-timer">ä¼šè¯å‰©ä½™ <span id="session-remaining">05:00</span></div>
    <button id="sound-toggle" title="å¼€å…³éŸ³æ•ˆ">ğŸ”Š éŸ³æ•ˆå·²å¼€</button>
  </div>
  <div id="confetti"></div>

  <!-- 1. æ¬¢è¿ & å§“å+å¯†ç  -->
  <div id="welcome">
    <h2>è¯·è¾“å…¥å§“åä¸å¯†ç  / Enter Your Name & Password</h2>
    <input type="text" id="username" placeholder="å§“å / Name"/>
    <input type="password" id="password" placeholder="å¯†ç  / Password"/>
    <button id="startBtn" type="button">ç™»å½• / Log In</button>
    <div class="help">è´­ä¹°å¯†ç è¯·è”ç³»çºªè€å¸ˆ 016-7312519</div>
  </div>

  <!-- 2. ç« èŠ‚é€‰æ‹© -->
  <div id="menu"><h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2></div>

  <!-- 3. æµ‹éªŒåŒºåŸŸ -->
  <div id="quiz">
    <h3 id="quiz-title"></h3>
    <div id="score">å¾—åˆ†: 0</div>
    <div id="remaining">å‰©ä½™é¢˜ç›®: 0</div>

    <div id="streak"></div>

    <div id="progressWrap" class="progress-wrap">
      <progress id="progress" value="0" max="0"></progress>
    </div>

    <div id="question-area" style="position:relative;"></div>
  </div>

  <!-- 4. æœ¬èŠ‚å®Œæˆ & ä¸Šä¼ æˆç»© -->
  <div id="finish">
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <div id="controls"></div>
  </div>

  <!-- æˆç»©ä¸ŠæŠ¥ -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbx9A1jZ8oqSKExIfVCKnNiFmvPy407QqZBnZTRalU0IL4DSuOp9Nb4izaynd_4C54j3/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
  </form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // === ç™»å½•/ä¼šè¯ ===
  let user = '', usedUniversal = false;
  const UWP_WINDOW_MS = 5 * 60 * 1000; // 5 åˆ†é’Ÿå¯ç”¨çª—å£

  function setUniversalStart(ts) { localStorage.setItem('uwpStart', String(ts)); }
  function getUniversalStart() { const v = localStorage.getItem('uwpStart'); return v? Number(v): 0; }
  function clearUniversalStart(){ localStorage.removeItem('uwpStart'); }

  function universalRemainingMs() {
    const start = getUniversalStart();
    if (!start) return 0;
    const remain = UWP_WINDOW_MS - (Date.now() - start);
    return remain > 0 ? remain : 0;
  }

  const timerEl = document.getElementById('session-timer');
  function showSessionTimer(show) { timerEl.style.display = show ? 'block' : 'none'; }
  function updateSessionTimer() {
    if (!usedUniversal) { showSessionTimer(false); return; }
    const rem = universalRemainingMs();
    if (rem <= 0) {
      showSessionTimer(false);
      alert('ä¼šè¯å·²åˆ°æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
      location.reload();
      return;
    }
    const mm = Math.floor(rem/60000);
    const ss = Math.floor((rem%60000)/1000).toString().padStart(2,'0');
    document.getElementById('session-remaining').textContent = `${mm}:${ss}`;
    showSessionTimer(true);
  }
  setInterval(updateSessionTimer, 500);

  // === éŸ³æ•ˆï¼ˆWeb Audio APIï¼‰ ===
  let audioOn = true;
  const sndBtn = document.getElementById('sound-toggle');
  sndBtn.onclick = () => {
    audioOn = !audioOn;
    sndBtn.classList.toggle('muted', !audioOn);
    sndBtn.textContent = audioOn ? 'ğŸ”Š éŸ³æ•ˆå·²å¼€' : 'ğŸ”ˆ éŸ³æ•ˆå·²å…³';
  };

  let audioCtx;
  function ensureCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  function beep(frequency=880, duration=0.14, type='sine', gain=0.06) {
    if (!audioOn) return;
    ensureCtx();
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = frequency;
    g.gain.value = gain;
    osc.connect(g).connect(audioCtx.destination);
    osc.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.stop(audioCtx.currentTime + duration + 0.02);
  }
  function playRight() {
    beep(1100, 0.10, 'sine', 0.06);
    setTimeout(()=>beep(1500, 0.12, 'sine', 0.05), 90); // â€œå®â€
  }
  function playWrong() {
    beep(220, 0.12, 'sawtooth', 0.05);
    setTimeout(()=>beep(160, 0.14, 'square', 0.05), 100); // â€œå™—â€
  }

  // === é¢˜åº“çŠ¶æ€ ===
  let chapters = [], grouped = {};
  let chapterKey, sectionKey, labelKey, sheetKey;
  let currentChapter = '', sectionList = [], secIndex = 0;
  let qs = [], queue = [], score = 0, correct = 0, wrong = 0;
  let chapterStart = 0;
  const MAX_OPTS = 15;

  // streak è®¡æ•°
  let correctStreak = 0, wrongStreak = 0;

  const PASSWORDS_CSV = 'Passwords.csv';

  document.getElementById('startBtn').onclick = attemptLogin;

  function attemptLogin() {
    const nm = document.getElementById('username').value.trim();
    const pw = document.getElementById('password').value;
    if (!nm || !pw) return alert('è¯·è¾“å…¥å§“åä¸å¯†ç  / Please enter both name and password.');

    Papa.parse(PASSWORDS_CSV, { download: true, header: true, skipEmptyLines: true,
      complete: (res) => {
        const rows = res.data.map(r => {
          const obj = {};
          Object.entries(r).forEach(([k,v])=>{
            obj[k.trim().toLowerCase()] = (typeof v === 'string') ? v.trim() : v;
          });
          return obj;
        });

        const nameKey = Object.keys(rows[0] || {}).find(k => k === 'name') || 'name';
        const passKey = Object.keys(rows[0] || {}).find(k => k === 'password') || 'password';

        const uwpRow = rows.find(r => (r[nameKey] === '*'));
        const uwpPassword = uwpRow ? (uwpRow[passKey] || '') : '';

        if (uwpPassword && pw === uwpPassword) {
          if (universalRemainingMs() <= 0) setUniversalStart(Date.now());
          usedUniversal = true;
          updateSessionTimer(); // ç«‹åˆ»æ˜¾ç¤ºå€’è®¡æ—¶
          user = nm;
          document.getElementById('welcome').style.display = 'none';
          loadChapters();
          return;
        }

        const match = rows.find(r =>
          (String(r[nameKey] || '').toLowerCase() === nm.toLowerCase()) &&
          (String(r[passKey] || '') === pw)
        );
        if (!match) return alert('å§“åæˆ–å¯†ç ä¸æ­£ç¡® / Name or password incorrect.');

        clearUniversalStart();
        usedUniversal = false;
        showSessionTimer(false);

        user = nm;
        document.getElementById('welcome').style.display = 'none';
        loadChapters();
      },
      error: () => alert('æ— æ³•è¯»å– Passwords.csvï¼Œè¯·ç¡®è®¤æ–‡ä»¶å­˜åœ¨ä¸”å¯å…¬å¼€è®¿é—®')
    });
  }

  function guardUniversalWindowOrThrow() {
    if (!usedUniversal) return;
    const remain = universalRemainingMs();
    if (remain <= 0) {
      alert('ä¼šè¯å·²åˆ°æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
      location.reload();
      throw new Error('Session expired');
    }
  }

  function loadChapters() {
    Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,
      complete(res) {
        guardUniversalWindowOrThrow();
        chapters = res.data.map(raw => {
          const r = {};
          Object.entries(raw).forEach(([k,v])=>{ r[k.trim()] = typeof v==='string'? v.trim(): v; });
          return r;
        });
        if (!chapters.length) return alert('è¯·æ£€æŸ¥ Chapters.csv');

        const keys = Object.keys(chapters[0]);
        chapterKey = keys.find(k=>k.toLowerCase()==='chapter');
        sectionKey = keys.find(k=>k.toLowerCase()==='section');
        labelKey   = keys.find(k=>k.toLowerCase()==='label');
        sheetKey   = keys.find(k=>k.toLowerCase()==='sheet');
        if (!chapterKey||!sectionKey||!labelKey||!sheetKey)
          return alert('Chapters.csv éœ€è¦åˆ—: chapter, section, label, sheet');

        grouped = {};
        chapters.forEach(r=>{
          const c = r[chapterKey];
          (grouped[c]||(grouped[c]=[])).push(r);
        });

        const menu = document.getElementById('menu');
        menu.innerHTML = '<h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2>';
        menu.style.display = 'block';
        Object.keys(grouped).forEach(chap => {
          const btn = document.createElement('button');
          btn.textContent = chap;
          btn.onclick = () => { guardUniversalWindowOrThrow(); startChapter(chap); };
          menu.appendChild(btn);
        });
      }
    });
  }

  function startChapter(chap) {
    guardUniversalWindowOrThrow();
    currentChapter = chap;
    sectionList = grouped[chap].sort((a,b)=> a[sectionKey].localeCompare(b[sectionKey]));
    secIndex = 0;
    document.getElementById('menu').style.display = 'none';
    loadSection();
  }

  function getBaseDir(url) {
    try {
      const u = new URL(url, window.location.href);
      const s = u.toString();
      const i = s.lastIndexOf('/');
      return i >= 0 ? s.slice(0, i+1) : s;
    } catch {
      const i = url.lastIndexOf('/');
      return i >= 0 ? url.slice(0, i+1) : '';
    }
  }

  function loadSection() {
    guardUniversalWindowOrThrow();

    const sec = sectionList[secIndex];
    const sheetUrl = sec[sheetKey];
    const baseDir = getBaseDir(sheetUrl);

    document.getElementById('quiz-title').textContent =
      `${currentChapter} â€“ ${sec[sectionKey]}: ${sec[labelKey]}`;
    score = correct = wrong = 0;
    correctStreak = 0; wrongStreak = 0;
    updateStreak();
    chapterStart = Date.now();

    Papa.parse(sheetUrl,{download:true,header:true,skipEmptyLines:true,
      complete(r) {
        qs = r.data.map(q=>({ ...q, attempt: 0, __baseDir: baseDir }));
        queue = shuffle([...qs]);
        document.getElementById('quiz').style.display='block';
        document.getElementById('finish').style.display='none';
        updateUI(0);
        nextQ();
      },
      error() {
        alert('æ— æ³•è¯»å–é¢˜åº“ CSVï¼Œè¯·æ£€æŸ¥é“¾æ¥ä¸è®¿é—®æƒé™');
        document.getElementById('menu').style.display = 'block';
      }
    });
  }

  function updateUI(delta) {
    document.getElementById('score').textContent =
      `å¾—åˆ†: ${score} (${delta>0?'+':''}${delta})`;
    document.getElementById('remaining').textContent = `å‰©ä½™é¢˜ç›®: ${queue.length}`;
    const pg = document.getElementById('progress');
    pg.max = qs.length; pg.value = qs.length - queue.length;
  }

  function flashProgress(isCorrect) {
    const wrap = document.getElementById('progressWrap');
    wrap.classList.remove('flash-green','flash-red');
    void wrap.offsetWidth; // è§¦å‘é‡ç»˜ä»¥ä¾¿é‡å¤åŠ¨ç”»
    wrap.classList.add(isCorrect ? 'flash-green' : 'flash-red');
    setTimeout(()=>wrap.classList.remove('flash-green','flash-red'), 600);
  }

  function updateStreak() {
    const el = document.getElementById('streak');
    if (correctStreak > 0) {
      el.innerHTML = `ğŸ”¥ <span class="streak-good">è¿å¯¹ ${correctStreak}</span>`;
    } else if (wrongStreak > 0) {
      el.innerHTML = `ğŸ˜… <span class="streak-bad">è¿é”™ ${wrongStreak}</span>`;
    } else {
      el.textContent = '';
    }
  }

  function nextQ() {
    guardUniversalWindowOrThrow();

    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; updateUI(0);
    if (queue.length===0) return finishSection();

    const q = queue.shift();
    const div = document.createElement('div');
    div.className = 'question';
    const safeQ = (q.question || '').toString().replace(/\r?\n/g,'<br/>');
    div.innerHTML = `<p><strong>${safeQ}</strong></p>`;

    if (q.image) {
      let src = (q.image || '').toString().trim();
      if (!/^https?:\/\//i.test(src) && !/^data:/i.test(src)) {
        src = (q.__baseDir || '') + src.replace(/^\.\//,'');
      }
      const img = document.createElement('img');
      img.src = src; img.alt = 'question image';
      div.appendChild(img);
    }

    const opts = document.createElement('div');
    opts.className = 'options';
    const qType = (q.type || '').toString().toLowerCase();
    if (qType === 'text') {
      opts.innerHTML = '<input type="text" id="txtAns" placeholder="è¯·è¾“å…¥ç­”æ¡ˆâ€¦"/>';
    } else {
      const letters = Array.from({length:MAX_OPTS}, (_,i)=>String.fromCharCode(65+i));
      const avail = letters.filter(l => q[l]); // A,B,C...
      // å›ºå®š ABCD é¡ºåº
      avail.forEach(l=>{
        const inp = document.createElement('input');
        inp.type = (qType==='checkbox')?'checkbox':'radio';
        inp.name = 'opt'; inp.value = l; inp.id = 'opt_'+l;
        const lbl = document.createElement('label');
        lbl.className = 'option-label'; lbl.htmlFor = 'opt_'+l;
        lbl.appendChild(inp);
        let raw = q[l];
        if (typeof raw === 'string' && /^-?\d+\.0$/.test(raw)) raw = String(parseInt(raw));
        lbl.append(' '+raw);
        opts.appendChild(lbl);
      });
    }
    div.appendChild(opts);

    const fb = document.createElement('div'); fb.className = 'feedback'; div.appendChild(fb);

    const sb = document.createElement('button'); sb.textContent = 'æäº¤';
    sb.onclick = () => {
      guardUniversalWindowOrThrow();

      let ua = [];
      if (qType==='text') {
        ua = document.getElementById('txtAns').value.split(',').map(s=>s.trim()).filter(s=>s);
      } else {
        ua = Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
      }
      if (!ua.length) return alert('è¯·é€‰æ‹©æˆ–è¾“å…¥ç­”æ¡ˆ');

      let isC=false;
      const ansStr = (q.answer || '').toString();
      if (qType==='text') {
        const lows = ua.map(s=>s.toLowerCase());
        const ansList = ansStr.split(',').map(s=>s.trim().toLowerCase());
        isC = lows.some(v=>ansList.includes(v));
      } else {
        const uaA = ua.map(s=>s.toUpperCase()).sort().join(',');
        const caA = ansStr.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
        isC = uaA===caA;
      }

      const delta = isC ? (q.attempt?1:2) : (q.attempt?-2:-1);
      score+=delta; if(isC) { correct++; correctStreak++; wrongStreak=0; } else { wrong++; wrongStreak++; correctStreak=0; }
      updateStreak();

      let ansTxt='';
      if (!isC) ansTxt = ansStr.split(',').map(letter => q[letter] || letter).join(' / ');
      fb.textContent = isC?`æ­£ç¡®! +${delta}`:`é”™è¯¯! ${delta} æ­£ç¡®ç­”æ¡ˆ: ${ansTxt}`;
      updateUI(delta);
      flashProgress(isC); // è¿›åº¦æ¡é¢œè‰²é—ªçƒ
      sb.disabled = true;

      // åŠ¨æ•ˆ + éŸ³æ•ˆ
      div.classList.remove('correct-glow','wrong-shake');
      const bubble = document.createElement('div');
      bubble.className = 'score-bubble ' + (delta>0 ? 'plus' : 'minus');
      bubble.textContent = (delta>0?'+':'') + String(delta);
      div.style.position = 'relative';
      div.appendChild(bubble);
      if (isC) { div.classList.add('correct-glow'); playRight(); setTimeout(()=>div.classList.remove('correct-glow'), 900); }
      else { div.classList.add('wrong-shake'); playWrong(); setTimeout(()=>div.classList.remove('wrong-shake'), 900); }
      setTimeout(()=> bubble.remove(), 1000);

      const nb = document.createElement('button');
      nb.style.marginLeft = '8px';
      nb.textContent = 'ä¸‹ä¸€é¢˜';
      nb.onclick = nextQ;
      div.appendChild(nb);

      // é”™é¢˜å›ç‚‰ï¼šåœ¨â€œåé¢éšæœºå‡ºç°ä¸¤æ¬¡â€
      if (!isC) { q.attempt++; insertWrongTwiceLater(q, queue); }
    };
    div.appendChild(sb);
    document.getElementById('question-area').appendChild(div);
  }

  function finishSection() {
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';
    document.getElementById('finish-msg').textContent = `æ­å–œ ${user}ï¼Œä½ å­¦ä¼šè¿™ä¸ªç« èŠ‚äº†ï¼`;
    document.getElementById('stats').textContent = `å¾—åˆ†: ${score}ï¼Œç­”å¯¹ ${correct} é¢˜ï¼Œç­”é”™ ${wrong} é¢˜`;

    // æˆç»©ä¸ŠæŠ¥
    const form = document.getElementById('postForm');
    form.quizId.value  = currentChapter + '_' + sectionList[secIndex][sectionKey];
    form.name.value    = user;
    form.score.value   = score;
    form.correct.value = correct;
    form.wrong.value   = wrong;
    form.time.value    = Math.floor((Date.now()-chapterStart)/1000);
    form.submit();

    // å½©å¸¦åº†ç¥ 1 ç§’
    launchConfetti(120, 1000);

    const ctrl = document.getElementById('controls');
    ctrl.innerHTML = '';
    const btn = document.createElement('button');
    btn.textContent = secIndex < sectionList.length-1 ? 'ä¸‹ä¸€èŠ‚' : 'è¿”å›ç« èŠ‚é€‰æ‹©';
    btn.onclick = () => {
      if (secIndex < sectionList.length-1) {
        guardUniversalWindowOrThrow();
        document.getElementById('finish').style.display = 'none';
        secIndex++; loadSection();
      } else {
        document.getElementById('finish').style.display = 'none';
        guardUniversalWindowOrThrow();
        document.getElementById('menu').style.display = 'block';
      }
    };
    ctrl.appendChild(btn);
  }

  // ===== å·¥å…· =====
  function shuffle(arr) {
    for (let i = arr.length-1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return arr;
  }
  // é”™é¢˜åœ¨â€œåé¢éšæœºå‡ºç°ä¸¤æ¬¡â€
  function insertWrongTwiceLater(q, queue) {
    const len = queue.length;
    let start = Math.min(1, len); // é¿å…ç´§æ¥ç€ä¸‹ä¸€é¢˜
    let end1  = len;
    let idx1  = (len <= start) ? start : (start + Math.floor(Math.random() * (end1 - start + 1)));
    queue.splice(idx1, 0, { ...q });

    const len2  = queue.length;
    const start2 = Math.min(1, len2);
    const end2  = len2;
    let idx2  = (len2 <= start2) ? start2 : (start2 + Math.floor(Math.random() * (end2 - start2 + 1)));
    if (Math.abs(idx2 - idx1) <= 1 && len2 >= 4) idx2 = Math.min(idx2 + 2, len2);
    queue.splice(idx2, 0, { ...q });
  }

  // ç®€æ˜“å½©å¸¦
  function launchConfetti(count=100, duration=1000) {
    const c = document.getElementById('confetti');
    const colors = ['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7','#14b8a6'];
    for (let i=0; i<count; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.style.left = Math.random()*100 + 'vw';
      piece.style.background = colors[i % colors.length];
      piece.style.animationDuration = (0.8 + Math.random()*0.8) + 's';
      piece.style.transform = `translateY(-120%) rotate(${Math.random()*360}deg)`;
      piece.style.width = (8 + Math.random()*6) + 'px';
      piece.style.height = (12 + Math.random()*10) + 'px';
      c.appendChild(piece);
      setTimeout(()=> piece.remove(), 2000);
    }
    setTimeout(()=> { c.innerHTML = ''; }, duration + 1200);
  }
});
</script>
</body>
</html>
