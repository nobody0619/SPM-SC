<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>纪老师 SPM SC 超强训练器</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:1000px; margin:auto; text-align:center; }
    #welcome,#menu,#quiz,#finish { margin:20px; }
    #menu,#quiz,#finish { display:none; }
    h2 { margin-top:30px; }
    h3 { margin-top:20px; text-align:left; }
    .group { margin:10px 0 25px; text-align:left; }
    .group h4 { margin:8px 0; }
    .group button { margin:5px; padding:8px 12px; }
    #topbar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin:12px 0; }
    .help { font-size: 0.95em; color:#444; margin-top:8px; }
    button { border:0; background:#111; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>

  <!-- 顶部条 -->
  <div id="topbar">
    <div id="session-timer" style="display:none;">会话剩余 <span id="session-remaining">05:00</span></div>
    <button id="sound-toggle" title="开关音效">🔊 音效已开</button>
  </div>

  <!-- 欢迎页 -->
  <div id="welcome">
    <h2>请输入姓名与密码 / Enter Your Name & Password</h2>
    <input type="text" id="username" placeholder="姓名 / Name"/>
    <input type="password" id="password" placeholder="密码 / Password"/>
    <button id="startBtn" type="button">登录 / Log In</button>
    <div class="help">购买密码请联系纪老师 016-7312519</div>
  </div>

  <!-- 章节选择 -->
  <div id="menu"><h2>请选择章节 / Select Chapter</h2></div>

  <!-- 测验区域 -->
  <div id="quiz">
    <h3 id="quiz-title"></h3>
    <div id="score">得分: 0</div>
    <div id="remaining">剩余题目: 0</div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="question-area"></div>
  </div>

  <!-- 完成页 -->
  <div id="finish">
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <div id="controls"></div>
  </div>

  <!-- 成绩上报 -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbx9A1jZ8oqSKExIfVCKnNiFmvPy407QqZBnZTRalU0IL4DSuOp9Nb4izaynd_4C54j3/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
  </form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let user = '';
  let chapters = [], grouped = {};
  let chapterKey, sectionKey, labelKey, sheetKey;
  let currentChapter = '', sectionList = [], secIndex = 0;
  let qs = [], queue = [], score = 0, correct = 0, wrong = 0;
  let chapterStart = 0;

  document.getElementById('startBtn').onclick = attemptLogin;

  function attemptLogin() {
    const nm = document.getElementById('username').value.trim();
    const pw = document.getElementById('password').value;
    if (!nm || !pw) return alert('请输入姓名与密码');
    // ⚠️ 简化：假设随便输入都能登录
    user = nm;
    document.getElementById('welcome').style.display = 'none';
    loadChapters();
  }

  function loadChapters() {
    Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,
      complete(res) {
        chapters = res.data.map(raw => {
          const r = {};
          Object.entries(raw).forEach(([k,v])=>{
            r[k.trim()] = typeof v==='string'? v.trim(): v;
          });
          return r;
        });
        if (!chapters.length) return alert('请检查 Chapters.csv');

        const keys = Object.keys(chapters[0]);
        chapterKey = keys.find(k=>k.toLowerCase()==='chapter');
        sectionKey = keys.find(k=>k.toLowerCase()==='section');
        labelKey   = keys.find(k=>k.toLowerCase()==='label');
        sheetKey   = keys.find(k=>k.toLowerCase()==='sheet');

        grouped = {};
        chapters.forEach(r=>{
          const c = r[chapterKey];
          (grouped[c]||(grouped[c]=[])).push(r);
        });

        renderMenu();
      }
    });
  }

  function renderMenu() {
    const menu = document.getElementById('menu');
    menu.innerHTML = '<h2>请选择章节 / Select Chapter</h2>';

    // 分区容器
    const statePapers = {2025:{},2024:{},2023:{}};
    const chaptersF4 = {2025:[],2024:[],2023:[]};
    const chaptersF5 = {2025:[],2024:[],2023:[]};

    Object.keys(grouped).forEach(chap => {
      const year = chap.match(/2025/) ? 2025 : chap.match(/2024/) ? 2024 : chap.match(/2023/) ? 2023 : null;
      if (!year) return;

      if (/Chp/i.test(chap)) {
        if (/F4/i.test(chap)) chaptersF4[year].push(chap);
        else if (/F5/i.test(chap)) chaptersF5[year].push(chap);
      } else {
        const state = chap.split(' ')[0];
        if (!statePapers[year][state]) statePapers[year][state] = [];
        statePapers[year][state].push(chap);
      }
    });

    // 州属试卷
    [2025,2024,2023].forEach(y=>{
      const states = statePapers[y];
      if (Object.keys(states).length) {
        const h = document.createElement('h2');
        h.textContent = `州属试卷 ${y}`;
        menu.appendChild(h);
        for (const st in states) {
          const g = document.createElement('div'); g.className='group';
          const h4 = document.createElement('h4'); h4.textContent = st;
          g.appendChild(h4);
          states[st].forEach(chap=>{
            const btn = document.createElement('button');
            btn.textContent = chap;
            btn.onclick = () => startChapter(chap);
            g.appendChild(btn);
          });
          menu.appendChild(g);
        }
      }
    });

    // Form 4
    [2025,2024,2023].forEach(y=>{
      if (chaptersF4[y].length) {
        const h = document.createElement('h2');
        h.textContent = `Form 4 Chapters ${y}`;
        menu.appendChild(h);
        const g = document.createElement('div'); g.className='group';
        chaptersF4[y].sort().forEach(chap=>{
          const btn = document.createElement('button');
          btn.textContent = chap;
          btn.onclick = () => startChapter(chap);
          g.appendChild(btn);
        });
        menu.appendChild(g);
      }
    });

    // Form 5
    [2025,2024,2023].forEach(y=>{
      if (chaptersF5[y].length) {
        const h = document.createElement('h2');
        h.textContent = `Form 5 Chapters ${y}`;
        menu.appendChild(h);
        const g = document.createElement('div'); g.className='group';
        chaptersF5[y].sort().forEach(chap=>{
          const btn = document.createElement('button');
          btn.textContent = chap;
          btn.onclick = () => startChapter(chap);
          g.appendChild(btn);
        });
        menu.appendChild(g);
      }
    });

    menu.style.display = 'block';
  }

  function startChapter(chap) {
    currentChapter = chap;
    sectionList = grouped[chap];
    secIndex = 0;
    document.getElementById('menu').style.display = 'none';
    loadSection();
  }

  function loadSection() {
    const sec = sectionList[secIndex];
    document.getElementById('quiz-title').textContent =
      `${currentChapter} – ${sec[sectionKey]}: ${sec[labelKey]}`;
    score = correct = wrong = 0;
    chapterStart = Date.now();

    Papa.parse(sec[sheetKey],{download:true,header:true,skipEmptyLines:true,
      complete(r) {
        qs = r.data.map(q=>({...q,attempt:0}));
        queue = [...qs];
        document.getElementById('quiz').style.display='block';
        document.getElementById('finish').style.display='none';
        updateUI(0);
        nextQ();
      }
    });
  }

  function updateUI(delta) {
    document.getElementById('score').textContent = `得分: ${score} (${delta>0?'+':''}${delta})`;
    document.getElementById('remaining').textContent = `剩余题目: ${queue.length}`;
    const pg = document.getElementById('progress');
    pg.max = qs.length; pg.value = qs.length - queue.length;
  }

  function nextQ() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; updateUI(0);
    if (queue.length===0) return finishSection();

    const q = queue.shift();
    const div = document.createElement('div');
    div.className = 'question';
    div.innerHTML = `<p><strong>${q.question}</strong></p>`;

    if (q.image) {
      const img = document.createElement('img');
      img.src = q.image; div.appendChild(img);
    }

    const opts = document.createElement('div');
    opts.className = 'options';
    const letters = ['A','B','C','D','E','F','G','H'];
    letters.filter(l=>q[l]).forEach(l=>{
      const inp = document.createElement('input');
      inp.type = q.type==='checkbox'?'checkbox':'radio';
      inp.name = 'opt'; inp.value = l; inp.id = 'opt_'+l;
      const lbl = document.createElement('label');
      lbl.className = 'option-label'; lbl.htmlFor = 'opt_'+l;
      lbl.appendChild(inp);
      lbl.append(' '+q[l]);
      opts.appendChild(lbl);
    });
    div.appendChild(opts);

    const fb = document.createElement('div'); fb.className = 'feedback'; div.appendChild(fb);

    const sb = document.createElement('button');
    sb.textContent = '提交';
    sb.onclick = () => {
      let ua = Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
      if (!ua.length) return alert('请选择答案');
      const ca = q.answer.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
      const uaA = ua.map(s=>s.toUpperCase()).sort().join(',');
      const isC = uaA===ca;
      const delta = isC?2:-1;
      score+=delta; if(isC) correct++; else wrong++;
      fb.textContent = isC?`正确! +${delta}`:`错误! ${delta} 正确答案: ${q.answer}`;
      updateUI(delta);
      sb.disabled = true;
      const nb = document.createElement('button'); nb.textContent = '下一题'; nb.onclick = nextQ; div.appendChild(nb);
    };
    div.appendChild(sb);

    qa.appendChild(div);
  }

  function finishSection() {
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';
    document.getElementById('finish-msg').textContent = `恭喜 ${user}，你学会这个章节了！`;
    document.getElementById('stats').textContent = `得分: ${score}，答对 ${correct} 题，答错 ${wrong} 题`;
    const form = document.getElementById('postForm');
    form.quizId.value = currentChapter + '_' + sectionList[secIndex][sectionKey];
    form.name.value = user;
    form.score.value = score;
    form.correct.value = correct;
    form.wrong.value = wrong;
    form.time.value = Math.floor((Date.now()-chapterStart)/1000);
    form.submit();
    const ctrl = document.getElementById('controls');
    ctrl.innerHTML = '';
    const btn = document.createElement('button');
    btn.textContent = secIndex < sectionList.length-1 ? '下一节' : '返回章节选择';
    btn.onclick = () => {
      document.getElementById('finish').style.display = 'none';
      if (secIndex < sectionList.length-1) { secIndex++; loadSection(); }
      else document.getElementById('menu').style.display = 'block';
    };
    ctrl.appendChild(btn);
  }
});
</script>
</body>
</html>
