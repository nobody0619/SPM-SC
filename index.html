<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ SPM SC è¶…å¼ºè®­ç»ƒå™¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width:1000px; margin:auto; text-align:center; }
    #welcome,#menu,#quiz,#finish { margin:20px; }
    #menu,#quiz,#finish { display:none; }
    h2 { margin-top:30px; }
    h3 { margin-top:20px; text-align:left; }
    .group { margin:10px 0 25px; text-align:left; }
    .group h4 { margin:8px 0; }
    .group button { margin:5px; padding:8px 12px; }
    #topbar { display:flex; align-items:center; justify-content:space-between; gap:8px; margin:12px 0; }
    .help { font-size: 0.95em; color:#444; margin-top:8px; }
    button { border:0; background:#111; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>

  <!-- é¡¶éƒ¨æ¡ -->
  <div id="topbar">
    <div id="session-timer" style="display:none;">ä¼šè¯å‰©ä½™ <span id="session-remaining">05:00</span></div>
    <button id="sound-toggle" title="å¼€å…³éŸ³æ•ˆ">ğŸ”Š éŸ³æ•ˆå·²å¼€</button>
  </div>

  <!-- æ¬¢è¿é¡µ -->
  <div id="welcome">
    <h2>è¯·è¾“å…¥å§“åä¸å¯†ç  / Enter Your Name & Password</h2>
    <input type="text" id="username" placeholder="å§“å / Name"/>
    <input type="password" id="password" placeholder="å¯†ç  / Password"/>
    <button id="startBtn" type="button">ç™»å½• / Log In</button>
    <div class="help">è´­ä¹°å¯†ç è¯·è”ç³»çºªè€å¸ˆ 016-7312519</div>
  </div>

  <!-- ç« èŠ‚é€‰æ‹© -->
  <div id="menu"><h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2></div>

  <!-- æµ‹éªŒåŒºåŸŸ -->
  <div id="quiz">
    <h3 id="quiz-title"></h3>
    <div id="score">å¾—åˆ†: 0</div>
    <div id="remaining">å‰©ä½™é¢˜ç›®: 0</div>
    <progress id="progress" value="0" max="0"></progress>
    <div id="question-area"></div>
  </div>

  <!-- å®Œæˆé¡µ -->
  <div id="finish">
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <div id="controls"></div>
  </div>

  <!-- æˆç»©ä¸ŠæŠ¥ -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm"
        action="https://script.google.com/macros/s/AKfycbx9A1jZ8oqSKExIfVCKnNiFmvPy407QqZBnZTRalU0IL4DSuOp9Nb4izaynd_4C54j3/exec"
        method="post" target="postFrame" style="display:none;">
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
  </form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let user = '';
  let chapters = [], grouped = {};
  let chapterKey, sectionKey, labelKey, sheetKey;
  let currentChapter = '', sectionList = [], secIndex = 0;
  let qs = [], queue = [], score = 0, correct = 0, wrong = 0;
  let chapterStart = 0;

  document.getElementById('startBtn').onclick = attemptLogin;

  function attemptLogin() {
    const nm = document.getElementById('username').value.trim();
    const pw = document.getElementById('password').value;
    if (!nm || !pw) return alert('è¯·è¾“å…¥å§“åä¸å¯†ç ');
    // âš ï¸ ç®€åŒ–ï¼šå‡è®¾éšä¾¿è¾“å…¥éƒ½èƒ½ç™»å½•
    user = nm;
    document.getElementById('welcome').style.display = 'none';
    loadChapters();
  }

  function loadChapters() {
    Papa.parse('Chapters.csv',{download:true,header:true,skipEmptyLines:true,
      complete(res) {
        chapters = res.data.map(raw => {
          const r = {};
          Object.entries(raw).forEach(([k,v])=>{
            r[k.trim()] = typeof v==='string'? v.trim(): v;
          });
          return r;
        });
        if (!chapters.length) return alert('è¯·æ£€æŸ¥ Chapters.csv');

        const keys = Object.keys(chapters[0]);
        chapterKey = keys.find(k=>k.toLowerCase()==='chapter');
        sectionKey = keys.find(k=>k.toLowerCase()==='section');
        labelKey   = keys.find(k=>k.toLowerCase()==='label');
        sheetKey   = keys.find(k=>k.toLowerCase()==='sheet');

        grouped = {};
        chapters.forEach(r=>{
          const c = r[chapterKey];
          (grouped[c]||(grouped[c]=[])).push(r);
        });

        renderMenu();
      }
    });
  }

  function renderMenu() {
    const menu = document.getElementById('menu');
    menu.innerHTML = '<h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2>';

    // åˆ†åŒºå®¹å™¨
    const statePapers = {2025:{},2024:{},2023:{}};
    const chaptersF4 = {2025:[],2024:[],2023:[]};
    const chaptersF5 = {2025:[],2024:[],2023:[]};

    Object.keys(grouped).forEach(chap => {
      const year = chap.match(/2025/) ? 2025 : chap.match(/2024/) ? 2024 : chap.match(/2023/) ? 2023 : null;
      if (!year) return;

      if (/Chp/i.test(chap)) {
        if (/F4/i.test(chap)) chaptersF4[year].push(chap);
        else if (/F5/i.test(chap)) chaptersF5[year].push(chap);
      } else {
        const state = chap.split(' ')[0];
        if (!statePapers[year][state]) statePapers[year][state] = [];
        statePapers[year][state].push(chap);
      }
    });

    // å·å±è¯•å·
    [2025,2024,2023].forEach(y=>{
      const states = statePapers[y];
      if (Object.keys(states).length) {
        const h = document.createElement('h2');
        h.textContent = `å·å±è¯•å· ${y}`;
        menu.appendChild(h);
        for (const st in states) {
          const g = document.createElement('div'); g.className='group';
          const h4 = document.createElement('h4'); h4.textContent = st;
          g.appendChild(h4);
          states[st].forEach(chap=>{
            const btn = document.createElement('button');
            btn.textContent = chap;
            btn.onclick = () => startChapter(chap);
            g.appendChild(btn);
          });
          menu.appendChild(g);
        }
      }
    });

    // Form 4
    [2025,2024,2023].forEach(y=>{
      if (chaptersF4[y].length) {
        const h = document.createElement('h2');
        h.textContent = `Form 4 Chapters ${y}`;
        menu.appendChild(h);
        const g = document.createElement('div'); g.className='group';
        chaptersF4[y].sort().forEach(chap=>{
          const btn = document.createElement('button');
          btn.textContent = chap;
          btn.onclick = () => startChapter(chap);
          g.appendChild(btn);
        });
        menu.appendChild(g);
      }
    });

    // Form 5
    [2025,2024,2023].forEach(y=>{
      if (chaptersF5[y].length) {
        const h = document.createElement('h2');
        h.textContent = `Form 5 Chapters ${y}`;
        menu.appendChild(h);
        const g = document.createElement('div'); g.className='group';
        chaptersF5[y].sort().forEach(chap=>{
          const btn = document.createElement('button');
          btn.textContent = chap;
          btn.onclick = () => startChapter(chap);
          g.appendChild(btn);
        });
        menu.appendChild(g);
      }
    });

    menu.style.display = 'block';
  }

  function startChapter(chap) {
    currentChapter = chap;
    sectionList = grouped[chap];
    secIndex = 0;
    document.getElementById('menu').style.display = 'none';
    loadSection();
  }

  function loadSection() {
    const sec = sectionList[secIndex];
    document.getElementById('quiz-title').textContent =
      `${currentChapter} â€“ ${sec[sectionKey]}: ${sec[labelKey]}`;
    score = correct = wrong = 0;
    chapterStart = Date.now();

    Papa.parse(sec[sheetKey],{download:true,header:true,skipEmptyLines:true,
      complete(r) {
        qs = r.data.map(q=>({...q,attempt:0}));
        queue = [...qs];
        document.getElementById('quiz').style.display='block';
        document.getElementById('finish').style.display='none';
        updateUI(0);
        nextQ();
      }
    });
  }

  function updateUI(delta) {
    document.getElementById('score').textContent = `å¾—åˆ†: ${score} (${delta>0?'+':''}${delta})`;
    document.getElementById('remaining').textContent = `å‰©ä½™é¢˜ç›®: ${queue.length}`;
    const pg = document.getElementById('progress');
    pg.max = qs.length; pg.value = qs.length - queue.length;
  }

  function nextQ() {
    const qa = document.getElementById('question-area');
    qa.innerHTML = ''; updateUI(0);
    if (queue.length===0) return finishSection();

    const q = queue.shift();
    const div = document.createElement('div');
    div.className = 'question';
    div.innerHTML = `<p><strong>${q.question}</strong></p>`;

    if (q.image) {
      const img = document.createElement('img');
      img.src = q.image; div.appendChild(img);
    }

    const opts = document.createElement('div');
    opts.className = 'options';
    const letters = ['A','B','C','D','E','F','G','H'];
    letters.filter(l=>q[l]).forEach(l=>{
      const inp = document.createElement('input');
      inp.type = q.type==='checkbox'?'checkbox':'radio';
      inp.name = 'opt'; inp.value = l; inp.id = 'opt_'+l;
      const lbl = document.createElement('label');
      lbl.className = 'option-label'; lbl.htmlFor = 'opt_'+l;
      lbl.appendChild(inp);
      lbl.append(' '+q[l]);
      opts.appendChild(lbl);
    });
    div.appendChild(opts);

    const fb = document.createElement('div'); fb.className = 'feedback'; div.appendChild(fb);

    const sb = document.createElement('button');
    sb.textContent = 'æäº¤';
    sb.onclick = () => {
      let ua = Array.from(div.querySelectorAll('input[name="opt"]:checked')).map(i=>i.value);
      if (!ua.length) return alert('è¯·é€‰æ‹©ç­”æ¡ˆ');
      const ca = q.answer.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
      const uaA = ua.map(s=>s.toUpperCase()).sort().join(',');
      const isC = uaA===ca;
      const delta = isC?2:-1;
      score+=delta; if(isC) correct++; else wrong++;
      fb.textContent = isC?`æ­£ç¡®! +${delta}`:`é”™è¯¯! ${delta} æ­£ç¡®ç­”æ¡ˆ: ${q.answer}`;
      updateUI(delta);
      sb.disabled = true;
      const nb = document.createElement('button'); nb.textContent = 'ä¸‹ä¸€é¢˜'; nb.onclick = nextQ; div.appendChild(nb);
    };
    div.appendChild(sb);

    qa.appendChild(div);
  }

  function finishSection() {
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';
    document.getElementById('finish-msg').textContent = `æ­å–œ ${user}ï¼Œä½ å­¦ä¼šè¿™ä¸ªç« èŠ‚äº†ï¼`;
    document.getElementById('stats').textContent = `å¾—åˆ†: ${score}ï¼Œç­”å¯¹ ${correct} é¢˜ï¼Œç­”é”™ ${wrong} é¢˜`;
    const form = document.getElementById('postForm');
    form.quizId.value = currentChapter + '_' + sectionList[secIndex][sectionKey];
    form.name.value = user;
    form.score.value = score;
    form.correct.value = correct;
    form.wrong.value = wrong;
    form.time.value = Math.floor((Date.now()-chapterStart)/1000);
    form.submit();
    const ctrl = document.getElementById('controls');
    ctrl.innerHTML = '';
    const btn = document.createElement('button');
    btn.textContent = secIndex < sectionList.length-1 ? 'ä¸‹ä¸€èŠ‚' : 'è¿”å›ç« èŠ‚é€‰æ‹©';
    btn.onclick = () => {
      document.getElementById('finish').style.display = 'none';
      if (secIndex < sectionList.length-1) { secIndex++; loadSection(); }
      else document.getElementById('menu').style.display = 'block';
    };
    ctrl.appendChild(btn);
  }
});
</script>
</body>
</html>
